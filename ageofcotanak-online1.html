<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Age of Çotanak: Online 1v1</title>
<link rel="icon" type="image/png" href="aoclogo.png">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{
    --ui-bg: rgba(18, 22, 28, 0.98);
    --ui-border: rgba(148, 163, 184, 0.3);
    --accent: #d97706;
    --font: 'Segoe UI', system-ui, sans-serif;
  }
  body{margin:0;overflow:hidden;background:#0f172a;font-family:var(--font);user-select:none; color:#e2e8f0;}

  #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
  canvas { position: absolute; inset: 0; pointer-events: none; }
  #game-stage { position: absolute; inset: 0; z-index: 1; cursor: crosshair; }
  #ui-layer { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
  .interactive { pointer-events: auto; }

  /* --- INTRO EKRANI --- */
  #intro-screen { position: fixed; inset: 0; z-index: 300; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 1s ease-in-out; }
  .intro-logo { font-size: 60px; font-weight: 900; color: #d97706; text-transform: uppercase; letter-spacing: 10px; text-shadow: 0 0 20px rgba(217, 119, 6, 0.5); opacity: 0; transform: scale(0.8); transition: all 1.5s ease-out; display: flex; flex-direction: column; align-items: center; }
  .intro-sub { margin-top: 10px; font-size: 16px; color: #64748b; letter-spacing: 5px; opacity: 0; transition: opacity 1.5s ease 0.5s; }
  .intro-active .intro-logo { opacity: 1; transform: scale(1.1); } .intro-active .intro-sub { opacity: 1; }

  /* UI ELEMENTLERİ */
  .top-hud { display: flex; gap: 15px; justify-content: center; padding: 12px; background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0) 100%); pointer-events: none; }
  .res-chip { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 6px 16px; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.6); pointer-events: auto; }
  .hud-icon { width: 20px; height: 20px; display: block; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); }
  .bottom-hud { position: absolute; bottom: 0; left: 0; width: 100%; display: flex; align-items: flex-end; justify-content: center; padding: 20px; gap: 10px; background: linear-gradient(0deg, #000 0%, rgba(0,0,0,0) 100%); pointer-events: none; }
  .hud-panel { background: var(--ui-bg); border: 1px solid var(--ui-border); border-radius: 4px; height: 140px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.9); pointer-events: auto; flex-shrink: 0; }
  #panel-info { width: 240px; flex-direction: column; align-items: flex-start; padding: 15px; gap: 5px; font-size: 14px; }

  #panel-actions{ width: min(520px, calc(100vw - 240px - 200px - 80px)); max-width: 560px; height: 140px; padding: 10px; gap: 8px; display: flex; flex-wrap: wrap; align-content: flex-start; justify-content: flex-start; overflow-y: auto; overflow-x: hidden; pointer-events: auto; scrollbar-width: thin; scrollbar-color: rgba(217,119,6,.7) rgba(15,23,42,.2); }
  #panel-actions::-webkit-scrollbar{ width: 8px; } #panel-actions::-webkit-scrollbar-track{ background: rgba(15,23,42,.2); border-radius: 8px; } #panel-actions::-webkit-scrollbar-thumb{ background: rgba(217,119,6,.7); border-radius: 8px; }

  .card{ width: 78px; height: 112px; background: #1e293b; border: 1px solid #475569; border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 6px; padding: 8px 6px; box-sizing: border-box; transition: all .1s; position: relative; overflow: hidden; }
  .card:hover { transform: translateY(-2px); background: #334155; border-color: var(--accent); } .card:active { transform: scale(0.95); }
  .card-title{ width: 100%; font-size: 10px; font-weight: 800; color: #e2e8f0; text-align: center; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-icon-svg{ width: 28px; height: 28px; display: block; flex: 0 0 auto; }
  .card-cost{ width: 100%; margin-top: auto; display: flex; flex-direction: column; gap: 2px; }
  .cost-row{ display: flex; align-items: center; justify-content: center; gap: 4px; font-size: 10px; font-weight: 800; line-height: 1; white-space: nowrap; }
  .mini-icon{ width: 12px; height: 12px; display: inline-block; flex: 0 0 auto; }
  .cost-row.wood{ color: #86efac; } .cost-row.hazel{ color: #f59e0b; }
  .card span { font-size: 10px; font-weight: 700; margin-top: 4px; color: #cbd5e1; text-align: center; }

  @media (max-width: 720px){ #panel-actions{ width: min(420px, calc(100vw - 240px - 200px - 60px)); } .card{ width: 72px; height: 108px; } }
  @media (max-width: 560px){ #panel-actions{ width: calc(100vw - 40px); max-width: none; } .bottom-hud{ justify-content: flex-start; } }

  .minimap-wrapper { width: 200px; height: 140px; padding: 0; overflow: hidden; position: relative; cursor: crosshair; border: 1px solid #475569; }
  #minimap { width: 100%; height: 100%; display: block; background: #020617; }
  #selection-box { position: absolute; border: 1px solid #fff; background: rgba(59, 130, 246, 0.2); display: none; z-index: 100; pointer-events: none; }
  .toast { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.9); padding: 12px 30px; border-radius: 4px; border-bottom: 2px solid var(--accent); color: #fbbf24; font-weight: bold; opacity: 0; transition: .3s; pointer-events: none; z-index: 100; font-family: monospace; letter-spacing: 1px; font-size: 16px; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }

  /* MENÜLER & LOBİ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
  .modal { background: #0f172a; padding: 40px; border-radius: 4px; border: 1px solid #334155; text-align: center; width: 400px; color: #fff; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
  .btn-start { width: 100%; margin: 15px 0; padding: 15px; background: #b45309; color: white; font-weight: bold; border: none; border-radius: 2px; cursor: pointer; font-size: 16px; transition: .2s; text-transform: uppercase; letter-spacing: 2px; pointer-events: auto; }
  .btn-start:hover { background: #d97706; }
  .diff-select { display:flex; gap:10px; margin-bottom:20px; }
  .diff-btn { flex:1; padding:10px; background:#1e293b; border:1px solid #334155; color:#94a3b8; cursor:pointer; border-radius:2px; font-weight: bold; }
  .diff-btn.active { background:var(--accent); color:#000; border-color:var(--accent); }

  .game-over-title { font-size: 42px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 5px; font-family: monospace; opacity: 0; transform: scale(0.5); transition: all 1s; }
  .game-over-show .game-over-title { opacity: 1; transform: scale(1); }
  .win { color: #22c55e; text-shadow: 0 0 30px #22c55e; }
  .lose { color: #ef4444; text-shadow: 0 0 30px #ef4444; }
  .blink { animation: blinker 1.5s linear infinite; color: #aaa; } @keyframes blinker { 50% { opacity: 0; } }
</style>
</head>
<body>

<div id="game-container">
  <audio id="bgm" src="bgm.mp3" preload="auto" loop></audio>
  <div id="intro-screen">
      <div class="intro-logo">
        <span>OGUZMEISTER</span>
        <span>GAMES</span>
       </div>
      <div class="intro-sub">PRESENTS</div>
  </div>

  <div id="game-stage">
    <svg id="game-svg" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="shadow" x="-50%" y="-20%" width="200%" height="150%"> <feDropShadow dx="2" dy="3" stdDeviation="2" flood-color="#000" flood-opacity="0.6"/> </filter>
        <linearGradient id="grad-gold" x1="0" y1="0" x2="1" y2="1"> <stop offset="0%" stop-color="#fcd34d"/><stop offset="100%" stop-color="#b45309"/> </linearGradient>
        <linearGradient id="grad-wood" x1="0" y1="0" x2="1" y2="0"> <stop offset="0%" stop-color="#78350f"/><stop offset="100%" stop-color="#451a03"/> </linearGradient>
        <linearGradient id="grad-hazel" x1="0" y1="0" x2="1" y2="1"> <stop offset="0%" stop-color="#8b4513"/><stop offset="100%" stop-color="#3f1d04"/> </linearGradient>
        <radialGradient id="grad-skin" cx="0.5" cy="0.5" r="0.5"> <stop offset="0%" stop-color="#fde68a"/><stop offset="100%" stop-color="#d97706"/> </radialGradient>
        <pattern id="pat-stone" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse"> <rect width="8" height="8" fill="#475569"/> <path d="M0 4 L8 4 M4 0 L4 8" stroke="#334155" stroke-width="0.5"/> </pattern>
        <pattern id="pat-grass" x="0" y="0" width="64" height="64" patternUnits="userSpaceOnUse"> <rect width="64" height="64" fill="#141b10"/> <circle cx="10" cy="10" r="1" fill="#1a2e05"/> <circle cx="40" cy="50" r="1.5" fill="#1a2e05"/> </pattern>
      </defs>
      <rect id="bg-rect" width="100%" height="100%" fill="url(#pat-grass)"/>
      <g id="layer-props"></g> <g id="layer-buildings"></g> <g id="layer-units"></g> <g id="layer-fx"></g> <g id="layer-ui-world"></g>
    </svg>
  </div>

  <div id="selection-box"></div>

  <div id="ui-layer">
    <div class="top-hud">
      <div class="res-chip" style="border-bottom: 2px solid #b45309;">
        <svg class="hud-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="url(#grad-gold)" stroke="#b45309" stroke-width="1.5"/><text x="12" y="16" font-size="12" text-anchor="middle" fill="#78350f" font-weight="bold">$</text></svg> <span id="ui-gold">0</span>
      </div>
      <div class="res-chip" style="border-bottom: 2px solid #166534;">
        <svg class="hud-icon" viewBox="0 0 24 24"><rect x="6" y="4" width="12" height="16" fill="url(#grad-wood)" rx="2"/><path d="M6 8 L18 8 M6 16 L18 16" stroke="#2e1402"/></svg> <span id="ui-wood">0</span>
      </div>
      <div class="res-chip" style="border-bottom: 2px solid #854d0e;">
        <svg class="hud-icon" viewBox="0 0 24 24"><path d="M12 2 Q20 2 20 12 Q20 22 12 22 Q4 22 4 12 Q4 2 12 2" fill="url(#grad-hazel)" stroke="#3f1d04" stroke-width="1.5"/><path d="M12 2 L12 8" stroke="#3f1d04"/></svg> <span id="ui-hazel">0</span>
      </div>
      <div class="res-chip" style="border-bottom: 2px solid #1e40af;">
        <svg class="hud-icon" viewBox="0 0 24 24"><path d="M12 4 A4 4 0 0 1 16 8 A4 4 0 0 1 12 12 A4 4 0 0 1 8 8 A4 4 0 0 1 12 4 M6 22 L6 16 Q6 12 12 12 Q18 12 18 16 L18 22" fill="#cbd5e1" stroke="#334155" stroke-width="1.5"/></svg> <span id="ui-pop">0/0</span>
      </div>
    </div>
    <div id="toast-msg" class="toast">Savaş Başladı</div>
    <div class="bottom-hud">
      <div id="panel-info" class="hud-panel"></div> <div id="panel-actions" class="hud-panel"></div>
      <div class="hud-panel minimap-wrapper"> <canvas id="minimap" width="200" height="140"></canvas> </div>
    </div>
  </div>

  <div id="start-screen" class="modal-overlay interactive" style="display:none;">
    <div class="modal">
      <h1 style="color:#d97706; margin:0 0 10px 0; text-shadow:0 3px 0 #000;">AGE OF ÇOTANAK</h1>
      <p style="color:#94a3b8; font-size:12px; margin-bottom:20px; letter-spacing:3px;">ONLINE WARLORDS</p>
      <button class="btn-start" style="background:#2563eb;" onclick="showLobby()">ONLINE ARENA'YA GİR</button>
    </div>
  </div>

  <div id="lobby-screen" class="modal-overlay interactive" style="display:none;">
    <div class="modal">
      <h1 style="color:#2563eb; margin:0 0 10px 0;">ONLINE LOBİ</h1>
      <div id="lobby-controls">
          <button class="btn-start" style="background:#0f766e;" onclick="createRoom()">ODA OLUŞTUR</button>
          <div style="margin: 15px 0; color:#64748b;">- VEYA -</div>
          <input type="text" id="room-code-input" placeholder="Oda Kodunu Gir" style="width:90%; padding:10px; background:#1e293b; border:1px solid #334155; color:#fff; text-align:center; font-weight:bold; margin-bottom:10px;">
          <button class="btn-start" style="background:#4338ca;" onclick="joinRoom()">ODAYA KATIL</button>
      </div>
      <div id="lobby-waiting" style="display:none; flex-direction:column; gap:15px;">
          <h2 style="color:#fbbf24;">ODA: <span id="display-room-code" style="color:#fff;">...</span></h2>
          <p class="blink">Rakip Bekleniyor...</p>
      </div>
      <button class="diff-btn" style="margin-top:20px; width:100%; border-color:transparent;" onclick="backToMenu()">GERİ DÖN</button>
    </div>
  </div>

  <div id="end-screen" class="modal-overlay interactive" style="display:none;">
      <div class="modal">
          <h1 id="end-title" class="game-over-title"></h1>
          <button class="btn-start" onclick="location.reload()">TEKRAR OYNA</button>
      </div>
  </div>
</div>

<script>
/* --- FIREBASE AYARLARI --- */
const firebaseConfig = {
  apiKey: "AIzaSyDqQhq2QiG8PDR_ieoyfGiHsB3F-Ryd94E",
  authDomain: "ageofcotanakonline.firebaseapp.com",
  databaseURL: "https://ageofcotanakonline-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ageofcotanakonline",
  storageBucket: "ageofcotanakonline.firebasestorage.app",
  messagingSenderId: "129139800724",
  appId: "1:129139800724:web:39b490070eae07b5405281"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* --- ONLINE DEĞİŞKENLERİ --- */
let isOnline = false;
let myRoomId = null;
let myPlayerId = 'p_' + Math.floor(Math.random() * 100000);
let amIHost = false;
let myTeam = 1; // 1: Mavi, 2: Kırmızı
let mapSeed = 0; // Harita Senkronizasyonu için

/* --- SEEDED RANDOM (AYNI HARİTA İÇİN) --- */
let rng = Math.random; // Varsayılan (lobi öncesi)
function seededRandom(a) {
    return function() {
      var t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
}

/* --- SABİTLER --- */
const CFG = { w: 2400, h: 2000 };
const COLORS = { p1: '#2563eb', p2: '#dc2626', p1Dark: '#1e3a8a', p2Dark: '#7f1d1d' };
const NS = "http://www.w3.org/2000/svg";

/* --- SVG İKONLAR --- */
const ICONS = {
    GOLD: `<svg viewBox="0 0 24 24" class="card-icon-svg"><circle cx="12" cy="12" r="10" fill="url(#grad-gold)" stroke="#b45309" stroke-width="2"/><text x="12" y="17" font-size="14" text-anchor="middle" fill="#b45309" font-weight="bold">$</text></svg>`,
    WOOD: `<svg viewBox="0 0 24 24" class="card-icon-svg"><rect x="4" y="4" width="16" height="16" fill="url(#grad-wood)" rx="2"/><path d="M4 8 L20 8 M4 16 L20 16" stroke="#451a03" stroke-width="2"/></svg>`,
    HAZEL: `<svg viewBox="0 0 24 24" class="card-icon-svg"><path d="M12 2 Q20 2 20 12 Q20 22 12 22 Q4 22 4 12 Q4 2 12 2" fill="url(#grad-hazel)" stroke="#3f1d04"/></svg>`,
    UNIT: `<svg viewBox="0 0 24 24" class="card-icon-svg"><circle cx="12" cy="8" r="5" fill="#cbd5e1"/><path d="M4 22 Q12 14 20 22" fill="#94a3b8"/></svg>`,
    SWORD: `<svg viewBox="0 0 24 24" class="card-icon-svg"><path d="M6 18 L18 6 M18 6 L20 8 M18 6 L16 4" stroke="#e2e8f0" stroke-width="3"/><path d="M6 18 L4 20" stroke="#94a3b8" stroke-width="3"/></svg>`,
    BOW: `<svg viewBox="0 0 24 24" class="card-icon-svg"><path d="M18 4 Q4 12 18 20" fill="none" stroke="#d97706" stroke-width="2"/><line x1="18" y1="4" x2="18" y2="20" stroke="#cbd5e1"/></svg>`,
    HORSE: `<svg viewBox="0 0 24 24" class="card-icon-svg"><defs><linearGradient id="grad-horse-1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#7c2d12"/></linearGradient></defs><path d="M6 19c-.7 0-1.2-.5-1.2-1.2 0-.4.2-.8.5-1l2.2-1.7 1.7-2.9c.2-.4.7-.6 1.1-.4l1.9.8 2.1-1.2c.3-.2.7-.2 1 0l2.2 1.4c.4.2.5.8.2 1.2l-1.3 2.1.8 2.5c.2.6-.2 1.1-.8 1.1h-1.6c-.4 0-.7-.2-.9-.6l-.6-1.1-1.9.9c-.3.1-.7.1-1-.1l-1.3-1-1 1.2c-.2.3-.6.5-1 .5H6z" fill="url(#grad-horse-1)" stroke="#1f2937" stroke-width="1" filter="url(#shadow)"/><path d="M13.8 9.5l1.1-2.4c.2-.5.7-.7 1.2-.5l1.9.8c.4.2.6.7.4 1.1l-.8 2.1" fill="none" stroke="#e2e8f0" stroke-width="1.5" stroke-linecap="round"/><circle cx="16.9" cy="7.9" r="0.9" fill="#0f172a"/></svg>`,
    SHIELD: `<svg viewBox="0 0 24 24" class="card-icon-svg"><path d="M4 4 L20 4 L18 16 Q12 22 6 16 Z" fill="#15803d" stroke="#fff" stroke-width="1"/></svg>`,
    WORKER: `<svg viewBox="0 0 24 24" class="card-icon-svg"><path d="M4 20 L20 4 M4 4 L8 8" stroke="#cbd5e1" stroke-width="3"/></svg>`,
    HOUSE: `<svg viewBox="0 0 24 24" class="card-icon-svg"><defs><linearGradient id="grad-house-1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#94a3b8"/><stop offset="100%" stop-color="#334155"/></linearGradient><linearGradient id="grad-roof-1" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#b45309"/></linearGradient></defs><path d="M4 11.5L12 4l8 7.5" fill="none" stroke="#e2e8f0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.5 10.8V20h11V10.8" fill="url(#grad-house-1)" stroke="#1f2937" stroke-width="1.5" stroke-linejoin="round" filter="url(#shadow)"/><path d="M12 4l8 7.5H4L12 4z" fill="url(#grad-roof-1)" stroke="#1f2937" stroke-width="1.2" stroke-linejoin="round"/><rect x="11" y="14" width="3" height="6" rx="1" fill="#0f172a" opacity="0.75"/><rect x="8" y="13" width="2.5" height="2.5" rx="0.6" fill="#fde68a" opacity="0.85"/><rect x="14.2" y="13" width="2.5" height="2.5" rx="0.6" fill="#fde68a" opacity="0.85"/></svg>`,
    BARRACKS: `<svg viewBox="0 0 24 24" class="card-icon-svg"><defs><linearGradient id="grad-barr-1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#64748b"/><stop offset="100%" stop-color="#1e293b"/></linearGradient><linearGradient id="grad-flag-1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#38bdf8"/><stop offset="100%" stop-color="#2563eb"/></linearGradient></defs><path d="M5 10.5l7-5 7 5" fill="#0f172a" opacity="0.35"/><path d="M6 11v9h12v-9" fill="url(#grad-barr-1)" stroke="#0b1220" stroke-width="1.5" stroke-linejoin="round" filter="url(#shadow)"/><path d="M6 11l6-4.5L18 11" fill="#334155" stroke="#0b1220" stroke-width="1.2" stroke-linejoin="round"/><rect x="9" y="14" width="2.4" height="2.4" rx="0.6" fill="#cbd5e1" opacity="0.75"/><rect x="12.8" y="14" width="2.4" height="2.4" rx="0.6" fill="#cbd5e1" opacity="0.75"/><rect x="11" y="17" width="3" height="3" rx="0.8" fill="#0f172a" opacity="0.75"/><path d="M12 6.2V3.8" stroke="#e2e8f0" stroke-width="1.6" stroke-linecap="round"/><path d="M12 4.2h5l-1.2 1.4L17 7h-5" fill="url(#grad-flag-1)" stroke="#0b1220" stroke-width="1" stroke-linejoin="round"/></svg>`,
    TOWER: `<svg viewBox="0 0 24 24" class="card-icon-svg"><defs><linearGradient id="grad-tower-1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#a78bfa"/><stop offset="100%" stop-color="#4f46e5"/></linearGradient><linearGradient id="grad-stone-1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#94a3b8"/><stop offset="100%" stop-color="#334155"/></linearGradient></defs><path d="M7 20V9.5L12 6l5 3.5V20" fill="url(#grad-stone-1)" stroke="#0b1220" stroke-width="1.5" stroke-linejoin="round" filter="url(#shadow)"/><path d="M6.2 9.8L12 5.7l5.8 4.1" fill="#475569" stroke="#0b1220" stroke-width="1.2" stroke-linejoin="round"/><path d="M9.2 12.5l2.8-1.8 2.8 1.8-2.8 1.8-2.8-1.8z" fill="url(#grad-tower-1)" stroke="#0b1220" stroke-width="1"/><circle cx="12" cy="12.5" r="1.1" fill="#0f172a" opacity="0.55"/><path d="M8.5 20l3.5-6 3.5 6" fill="none" stroke="#fbbf24" stroke-width="1.4" stroke-linecap="round" opacity="0.9"/></svg>`,
    CATAPULT: `<svg viewBox="0 0 24 24" class="card-icon-svg"><rect x="4" y="14" width="16" height="5" rx="2" fill="#6b4f2a" stroke="#2e1402"/><circle cx="8" cy="20" r="2" fill="#334155"/><circle cx="16" cy="20" r="2" fill="#334155"/><path d="M7 14 L12 6 L17 14" fill="none" stroke="#cbd5e1" stroke-width="2"/><circle cx="12" cy="6" r="2" fill="#94a3b8"/></svg>`
};

const DB = {
  UNIT: {
    VILLAGER: { name: 'İşçi', hp: 60, atk: 5, range: 20, spd: 90, cost: {wood:50}, buildTime: 5, role: 'worker', type:'inf', visual:'WORKER' },
    PIKEMAN:  { name: 'Mızraklı', hp: 140, atk: 12, range: 35, spd: 100, cost: {wood:60, gold:20}, buildTime: 8, role: 'soldier', type:'inf', bonus:'cav', visual:'SWORD' },
    ARCHER:   { name: 'Okçu', hp: 80, atk: 9, range: 240, spd: 110, cost: {wood:50, gold:40}, buildTime: 10, role: 'soldier', type:'ranged', proj: true, visual:'BOW' },
    KNIGHT:   { name: 'Süvari', hp: 280, atk: 18, range: 30, spd: 190, cost: {wood:40, gold:90}, buildTime: 15, role: 'soldier', type:'cav', visual:'HORSE' },
    F_KNIGHT: { name: 'Muhafız', hp: 600, atk: 45, range: 35, spd: 140, cost: {gold:100, hazel:150}, buildTime: 25, role: 'soldier', type:'heavy', visual:'SHIELD' },
    CATAPULT: { name: 'Mancınık', hp: 260, atk: 40, range: 420, spd: 70, cost: {wood:140, gold:80}, buildTime: 22, role: 'soldier', type:'siege', proj: true, visual:'CATAPULT' }
  },
  BUILD: {
    HOUSE:    { name: 'Barınak', hp: 500, w: 90, h: 90, cost: {wood:40}, cap: 5, buildTime: 10, visual:'HOUSE', desc:'Nüfus: +5' },
    BARRACKS: { name: 'Kışla', hp: 1200, w: 140, h: 140, cost: {wood:150, gold:20}, buildTime: 20, visual:'BARRACKS', desc:'Piyade' },
    ARCHERY:  { name: 'Okçu Alanı', hp: 1000, w: 130, h: 130, cost: {wood:150, gold:20}, buildTime: 20, visual:'TOWER', desc:'Okçu / Mancınık' },
    STABLE:   { name: 'Ahır', hp: 1500, w: 160, h: 150, cost: {wood:200, gold:100}, buildTime: 25, visual:'HORSE', desc:'Süvari' },
    ARROW_TOWER: { name: 'Okçu Kulesi', hp: 900, w: 90, h: 140, cost: {wood:170, gold:40}, buildTime: 18, visual:'TOWER', desc:'Savunma', atk: 10, range: 320, proj: true, fireRate: 1.05 },
    TOWN:     { name: 'Kale', hp: 5000, w: 220, h: 200, cost: {wood:9999}, cap: 10, buildTime: 999, visual:'TOWN', unique:true }
  }
};

let GAME = {
  t: 0, last: 0, over: false, difficulty: 'NORMAL',
  cam: { x: 0, y: 0, w: window.innerWidth, h: window.innerHeight },
  mouse: { wx: 0, wy: 0, screenX:0, screenY:0, down: false, dragStart: null },
  keys: {},
  entities: { units: [], buildings: [], props: [], proj: [], particles: [] },
  selection: [], lastSelectionId: null,
  player: { gold: 300, wood: 300, hazel: 0 },
  ghost: { active: false, type: null, el: null, valid: false },
  dom: {}
};

function clamp01(x){ return Math.max(0, Math.min(1, x)); }

window.onload = function() {
    const intro = document.getElementById('intro-screen');
    const start = document.getElementById('start-screen');
    const svg = document.getElementById('game-svg');

    if(svg) { svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%'); }

    if(intro){
        setTimeout(() => {
            intro.classList.add('intro-active');
            setTimeout(() => {
                intro.style.opacity = '0';
                setTimeout(() => {
                    intro.style.display = 'none';
                    if(start) start.style.display = 'flex';
                }, 1000);
            }, 2500);
        }, 100);
    } else {
        if(start) start.style.display = 'flex';
    }
};

/* --- LOBİ FONKSİYONLARI --- */
function showLobby(){
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('lobby-screen').style.display = 'flex';
}

function backToMenu(){
    document.getElementById('lobby-screen').style.display = 'none';
    document.getElementById('start-screen').style.display = 'flex';
}

function createRoom(){
    myRoomId = Math.floor(1000 + Math.random() * 9000).toString();
    amIHost = true;
    mapSeed = Math.floor(Math.random() * 100000); // Host haritayı belirler

    db.ref('rooms/' + myRoomId).set({
        host: myPlayerId,
        guest: null,
        status: 'waiting',
        seed: mapSeed
    });

    document.getElementById('lobby-controls').style.display = 'none';
    document.getElementById('lobby-waiting').style.display = 'flex';
    document.getElementById('display-room-code').innerText = myRoomId;
    listenForGameStart();
}

function joinRoom(){
    const inputCode = document.getElementById('room-code-input').value;
    if(!inputCode || inputCode.length !== 4) { alert("Lütfen 4 haneli kodu girin."); return; }

    myRoomId = inputCode;
    amIHost = false;

    const roomRef = db.ref('rooms/' + myRoomId);

    roomRef.get().then((snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            if(data.status !== 'waiting'){ alert("Bu oda dolu veya başlamış!"); return; }

            roomRef.update({ guest: myPlayerId, status: 'starting' });
            mapSeed = data.seed; // Host'un haritasını al

            showToast("Odaya Katıldın! Başlıyor...");
            listenForGameStart();
        } else { alert("Böyle bir oda bulunamadı."); }
    }).catch((error) => { console.error(error); alert("Bağlantı hatası."); });
}

function listenForGameStart(){
    db.ref('rooms/' + myRoomId + '/status').on('value', (snapshot) => {
        const status = snapshot.val();
        if(status === 'starting'){
            isOnline = true;
            document.getElementById('lobby-screen').style.display = 'none';
            // Host Mavi(1), Guest Kırmızı(2)
            myTeam = amIHost ? 1 : 2;
            showToast(`BAĞLANDI! SEN ${myTeam === 1 ? 'MAVİ' : 'KIRMIZI'} TAKIMSIN.`);

            startGame();
            listenForActions();
        }
    });
}

/* --- ACTION SYNC (AKSİYON PAYLAŞIMI) --- */
function sendAction(data){
    if(!isOnline) return;
    db.ref('rooms/' + myRoomId + '/actions').push({ ...data, senderTeam: myTeam });
}

function listenForActions(){
    db.ref('rooms/' + myRoomId + '/actions').on('child_added', (snapshot) => {
        const action = snapshot.val();
        if(action.senderTeam === myTeam) return; // Kendi aksiyonumuzu zaten yaptık
        handleRemoteAction(action);
    });
}

function handleRemoteAction(act){
    if(act.type === 'MOVE'){
        act.uids.forEach(id => {
            const u = GAME.entities.units.find(x => x.id === id);
            if(u) { u.dest = {x:act.x, y:act.y}; u.target=null; u.task=null; u.manualTarget=false; }
        });
    }
    else if(act.type === 'ATTACK'){
        const t = GAME.entities.units.find(x => x.id === act.tid) || GAME.entities.buildings.find(x => x.id === act.tid);
        if(t){
            act.uids.forEach(id => {
                const u = GAME.entities.units.find(x => x.id === id);
                if(u) { u.target = t; u.manualTarget=true; u.task=null; u.dest=null; }
            });
        }
    }
    else if(act.type === 'GATHER'){
        const t = GAME.entities.props.find(x => x.id === act.tid);
        if(t){
            act.uids.forEach(id => {
                const u = GAME.entities.units.find(x => x.id === id);
                if(u) { u.task = {type:'gather', id:t.id}; u.manualTarget=false; u.dest=null; }
            });
        }
    }
    else if(act.type === 'BUILD'){
        // act.bid / act.bType / act.x / act.y bekleniyor
        let b = spawnBuilding(act.bType, act.senderTeam, act.x, act.y, false, act.bid);
        act.uids.forEach(id => {
            const u = GAME.entities.units.find(x => x.id === id);
            if(u) u.task = {type:'build', id:b.id};
        });
    }
    else if(act.type === 'TRAIN'){
        const b = GAME.entities.buildings.find(x => x.id === act.bid);
        if(b){
            b.queue.push({type: act.uType, def:DB.UNIT[act.uType], prog:0, forcedId: act.newUid});
        }
    }
}

function startGame(){
  const bgm = document.getElementById('bgm');
  if(bgm){
    bgm.volume = 0.35;
    bgm.play().catch(()=>{});
  }

  rng = seededRandom(mapSeed);

  GAME.dom = {
    svg: document.getElementById('game-svg'),
    layers: {
      units: document.getElementById('layer-units'),
      build: document.getElementById('layer-buildings'),
      props: document.getElementById('layer-props'),
      fx: document.getElementById('layer-fx'),
      ui: document.getElementById('layer-ui-world')
    }
  };

  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('bg-rect').setAttribute('width', CFG.w);
  document.getElementById('bg-rect').setAttribute('height', CFG.h);

  generateMap();

  spawnBuilding('TOWN', 1, 300, 300, true);
  spawnBuilding('HOUSE', 1, 550, 350, true);
  spawnUnit('VILLAGER', 1, 450, 500);
  spawnUnit('VILLAGER', 1, 500, 550);

  const ex = CFG.w-400, ey = CFG.h-400;
  spawnBuilding('TOWN', 2, ex, ey, true);
  spawnBuilding('HOUSE', 2, ex-200, ey, true);
  spawnUnit('VILLAGER', 2, ex-100, ey+100);
  spawnUnit('VILLAGER', 2, ex+50, ey+150);

  if(myTeam === 2){
      GAME.cam.x = CFG.w - GAME.cam.w;
      GAME.cam.y = CFG.h - GAME.cam.h;
  }

  setupInputs();
  requestAnimationFrame(loop);
}

function generateMap(){
  const spawnPropSafe = (type, count, r) => {
    let attempts = 0, placed = 0;
    while(placed < count && attempts < count * 20){
        attempts++;
        const x = rng() * (CFG.w - 300) + 150;
        const y = rng() * (CFG.h - 300) + 150;
        if(Math.hypot(x-300, y-300) < 400 || Math.hypot(x-(CFG.w-400), y-(CFG.h-400)) < 400) continue;
        if(checkPlacement(x, y, r*2, r*2)){ createProp(type, x, y, r); placed++; }
    }
  };
  spawnPropSafe('wood', 120, 30);
  spawnPropSafe('gold', 30, 25);
  spawnPropSafe('hazel', 20, 20);
}

function createProp(type, x, y, r){
    const el = document.createElementNS(NS, 'g');
    let svg = `<ellipse cx="0" cy="${r/2}" rx="${r}" ry="${r/2}" fill="rgba(0,0,0,0.3)"/>`;
    if(type === 'wood'){
       const s = 0.8 + rng()*0.4;
       svg += `<g transform="scale(${s})"><path d="M-5,0 L-8,15 L8,15 L5,0 Z" fill="url(#grad-wood)"/>
               <circle cx="0" cy="-20" r="22" fill="#14532d"/><circle cx="-12" cy="-12" r="14" fill="#166534"/>
               <circle cx="12" cy="-12" r="14" fill="#15803d"/><circle cx="0" cy="-30" r="16" fill="#16a34a"/></g>`;
    } else if(type === 'gold'){
       svg += `<path d="M-15,10 L-5,-10 L15,10 Z" fill="#64748b"/><path d="M-5,10 L5,-15 L15,5 Z" fill="#94a3b8"/>
               <circle cx="-5" cy="5" r="5" fill="url(#grad-gold)"/><circle cx="8" cy="0" r="4" fill="url(#grad-gold)"/>`;
    } else {
       svg += `<g transform="scale(1.2)"><path d="M0,0 Q5,0 5,10 Q5,20 0,20 Q-5,20 -5,10 Q-5,0 0,0" fill="#8b4513"/>
               <path d="M0,0 L0,-5" stroke="#3f1d04" stroke-width="2"/><circle cx="2" cy="5" r="2" fill="#a0522d"/></g>`;
    }
    el.innerHTML = svg;
    el.setAttribute('transform', `translate(${x},${y})`);
    GAME.dom.layers.props.appendChild(el);
    GAME.entities.props.push({id:rng(), type, x, y, amt: type==='wood'?300:600, r:r, el});
}

function checkPlacement(x, y, w, h, ignoreSelfId=null){
    if(x - w/2 < 0 || x + w/2 > CFG.w || y - h/2 < 0 || y + h/2 > CFG.h) return false;
    const bx = x - w/2, by = y - h/2;

    for(let b of GAME.entities.buildings){
        if(b.id === ignoreSelfId || b.dead) continue;
        if(bx < b.x + b.w && bx + w > b.x && by < b.y + b.h && by + h > b.y) return false;
    }

    for(let p of GAME.entities.props){
        if(p.dead || (p.amt !== undefined && p.amt <= 0)) continue;
        if(Math.hypot(x - p.x, y - p.y) < (Math.max(w,h)/2 + p.r)) return false;
    }
    return true;
}

function getBuildingSVG(type, team){
    const def = DB.BUILD[type];
    const c1 = team===1 ? '#2563eb' : '#dc2626';
    const roof = '#334155';
    let svg = '';

    if(type === 'TOWN'){
        const W = def.w, H = def.h;
        const wallY = Math.floor(H*0.34);

        const keepW = 90;
        const keepH = Math.floor(H*0.38);
        const keepX = Math.floor(W/2 - keepW/2);

        // Keep (orta kule) üst çizgisi (çatı buraya OTURACAK)
        const keepY = Math.floor(wallY - keepH + 10);

        // Ana Duvarlar
        svg += `<rect x="8" y="${wallY}" width="${W-16}" height="${H-wallY-6}" rx="4" fill="url(#pat-stone)" stroke="#1e293b" stroke-width="2"/>`;

        // Mazgallar
        for(let i=0;i<10;i++){
          const bx = 16 + i*((W-32)/10);
          svg += `<rect x="${bx}" y="${wallY-10}" width="12" height="12" fill="#475569" stroke="#1e293b" stroke-width="1"/>`;
        }

        // Kapı
        svg += `<rect x="${Math.floor(W/2-28)}" y="${H-64}" width="56" height="58" rx="6" fill="#1e293b"/>`;
        svg += `<path d="M${Math.floor(W/2-28)},${H-64} L${Math.floor(W/2+28)},${H-64}" stroke="#475569" stroke-width="2"/>`;
        svg += `<circle cx="${Math.floor(W/2-10)}" cy="${H-35}" r="3" fill="#94a3b8"/>`;
        svg += `<circle cx="${Math.floor(W/2+10)}" cy="${H-35}" r="3" fill="#94a3b8"/>`;

        // Orta Kule (Keep)
        svg += `<rect x="${keepX}" y="${keepY}" width="${keepW}" height="${keepH}" rx="4" fill="url(#pat-stone)" stroke="#1e293b" stroke-width="2"/>`;

        // ✅ DÜZELTME: Çatı tabanı keep’in TAM üst çizgisinde (keepY)
        // Eski kodda roofBaseY+10 gibi değerler çatıyı içeri "gömüyordu".
        const roofBaseY = keepY;               // taban = keep üstü
        const roofPeakY = roofBaseY - 34;      // tepe yüksekliği
        const overhang = 10;                   // saçak payı

        svg += `<path d="M${keepX-overhang},${roofBaseY} L${Math.floor(W/2)},${roofPeakY} L${keepX+keepW+overhang},${roofBaseY} Z"
                 fill="${roof}" stroke="#1e293b" stroke-width="1.5"/>`;

        // Bayrak Direği
        svg += `<line x1="${Math.floor(W/2)}" y1="${roofPeakY}" x2="${Math.floor(W/2)}" y2="${roofPeakY-30}"
                 stroke="#0b1220" stroke-width="3"/>`;

        // Bayrak
        svg += `<path d="M${Math.floor(W/2)} ${roofPeakY-30} L${Math.floor(W/2)+34} ${roofPeakY-20} L${Math.floor(W/2)} ${roofPeakY-10} Z"
                 fill="${c1}" stroke="#0b1220" stroke-width="1"/>`;

        // Pencereler
        svg += `<rect x="${keepX+14}" y="${roofBaseY+22}" width="12" height="18" rx="3" fill="#0f172a" opacity="0.7"/>`;
        svg += `<rect x="${keepX+keepW-26}" y="${roofBaseY+22}" width="12" height="18" rx="3" fill="#0f172a" opacity="0.7"/>`;
    }
    else if(type === 'HOUSE'){
        svg += `<rect x="10" y="${def.h*0.4}" width="${def.w-20}" height="${def.h*0.6}" fill="url(#pat-stone)" stroke="#1e293b"/>`;
        svg += `<path d="M0,${def.h*0.4} L${def.w/2},0 L${def.w},${def.h*0.4} Z" fill="${roof}"/>`;
        svg += `<rect x="${def.w/2-10}" y="${def.h-30}" width="20" height="30" fill="#3f2e20"/>`;
    }
    else if(type === 'BARRACKS'){
        svg += `<rect x="5" y="${def.h*0.4}" width="${def.w-10}" height="${def.h*0.6}" fill="url(#pat-stone)" stroke="#1e293b"/>`;
        svg += `<path d="M0,${def.h*0.4} L20,10 L${def.w-20},10 L${def.w},${def.h*0.4} Z" fill="${roof}"/>`;
        svg += `<rect x="${def.w/2-25}" y="${def.h-40}" width="50" height="40" fill="#3f2e20"/>`;
        svg += `<circle cx="${def.w/2}" cy="${def.h*0.25}" r="12" fill="${c1}" stroke="#fff" stroke-width="2"/>`;
    }
    else if(type === 'STABLE'){
        const W = def.w, H = def.h;
        svg += `<rect x="5" y="${H*0.4}" width="${W-10}" height="${H*0.6}" fill="#5c2e08" stroke="#2e1402" stroke-width="2"/>`;
        svg += `<path d="M0,${H*0.4} L${W/2},0 L${W},${H*0.4} Z" fill="${roof}" stroke="#0b1220" stroke-width="2"/>`;
        for(let i=1; i<4; i++){ let x = 5 + i*((W-10)/4); svg += `<line x1="${x}" y1="${H*0.4}" x2="${x}" y2="${H}" stroke="#3f2e20" stroke-width="2"/>`; }
        svg += `<rect x="5" y="${H*0.4}" width="8" height="${H*0.6}" fill="#3f2e20"/>`;
        svg += `<rect x="${W-13}" y="${H*0.4}" width="8" height="${H*0.6}" fill="#3f2e20"/>`;
        svg += `<circle cx="${W/2}" cy="${H*0.3}" r="8" fill="${c1}" stroke="#fff" stroke-width="2"/>`;
    }
    else if(type === 'ARCHERY'){
        svg += `<rect x="${def.w*0.6}" y="10" width="${def.w*0.3}" height="${def.h-10}" fill="url(#pat-stone)" stroke="#1e293b"/>`;
        svg += `<path d="M${def.w*0.6-10},10 L${def.w*0.75},-10 L${def.w*0.9+10},10 Z" fill="${roof}"/>`;
        svg += `<rect x="10" y="${def.h*0.5}" width="${def.w*0.5}" height="${def.h*0.5}" fill="#5c2e08"/>`;
        svg += `<circle cx="35" cy="${def.h*0.7}" r="10" fill="#fff" stroke="#b91c1c" stroke-width="3"/>`;
        svg += `<circle cx="35" cy="${def.h*0.7}" r="3" fill="#b91c1c"/>`;
    }
    else if(type === 'ARROW_TOWER'){
        const W = def.w, H = def.h;
        svg += `<rect x="10" y="${Math.floor(H*0.3)}" width="${W-20}" height="${Math.floor(H*0.7)-8}" rx="6" fill="url(#pat-stone)" stroke="#1e293b" stroke-width="2"/>`;
        svg += `<rect x="14" y="${Math.floor(H*0.28)}" width="${W-28}" height="16" rx="4" fill="#475569" stroke="#1e293b" stroke-width="2"/>`;
        for(let i=0;i<4;i++){ const x = 18 + i*((W-36)/4); svg += `<rect x="${x}" y="${Math.floor(H*0.28)+3}" width="10" height="10" rx="2" fill="#1e293b" opacity="0.9"/>`; }
        svg += `<path d="M6 ${Math.floor(H*0.3)} L${Math.floor(W/2)} 8 L${W-6} ${Math.floor(H*0.3)} Z" fill="${roof}" stroke="#0b1220" stroke-width="2"/>`;
        svg += `<circle cx="${Math.floor(W/2)}" cy="${Math.floor(H*0.55)}" r="10" fill="${c1}" stroke="#fff" stroke-width="2"/>`;
    }

    return `<g filter="url(#shadow)">${svg}</g>`;
}

function getTargetCenter(t){
  const tx = t.x + (t.w ? t.w/2 : 0);
  const ty = t.y + (t.h ? t.h/2 : 0);
  return {tx, ty};
}

function loop(t){
  if(GAME.over) return;
  const dt = Math.min((t - GAME.last) / 1000, 0.1);
  GAME.last = t; GAME.t += dt;
  try {
      updateCamera(dt);
      updateLogic(dt);

      if(!isOnline) updateFairAI(dt);

      updateLiveUI();
      render(dt);
  } catch(e) { console.error(e); }
  requestAnimationFrame(loop);
}

function updateCamera(dt){
    const s = 1200 * dt; const m = 30;
    if(GAME.keys['w'] || GAME.keys['W']) GAME.cam.y = Math.max(0, GAME.cam.y - s);
    if(GAME.keys['s'] || GAME.keys['S']) GAME.cam.y = Math.min(CFG.h - GAME.cam.h, GAME.cam.y + s);
    if(GAME.keys['a'] || GAME.keys['A']) GAME.cam.x = Math.max(0, GAME.cam.x - s);
    if(GAME.keys['d'] || GAME.keys['D']) GAME.cam.x = Math.min(CFG.w - GAME.cam.w, GAME.cam.x + s);
    if(GAME.mouse.screenX < m && GAME.mouse.screenX > 0) GAME.cam.x = Math.max(0, GAME.cam.x - s);
    if(GAME.mouse.screenX > window.innerWidth - m) GAME.cam.x = Math.min(CFG.w - GAME.cam.w, GAME.cam.x + s);
    if(GAME.mouse.screenY < m && GAME.mouse.screenY > 0) GAME.cam.y = Math.max(0, GAME.cam.y - s);
    if(GAME.mouse.screenY > window.innerHeight - m) GAME.cam.y = Math.min(CFG.h - GAME.cam.h, GAME.cam.y + s);
}

function updateLogic(dt){
  GAME.entities.buildings.forEach(b => {
    if(b.constructed && b.queue.length){
        b.queue[0].prog += dt;
        if(Math.random()<0.1) spawnParticle(b.x+b.w/2, b.y, '#fff', 1);
        if(b.queue[0].prog >= b.queue[0].def.buildTime){
            const q = b.queue[0];
            spawnUnit(q.type, b.team, b.x+b.w/2, b.y+b.h+10, q.forcedId || null);
            b.queue.shift();
            if(b.team===myTeam) { showToast("Birim Hazır!"); updatePanel(true); }
        }
    }
    if(!b.constructed && b.hp >= b.def.hp * 0.99){ b.hp = b.def.hp; b.constructed = true; }
    if(b.constructed && !b.dead && b.def && b.def.atk && b.def.range){
      if(b.cd === undefined) b.cd = 0;
      const enemyTeam = b.team === 1 ? 2 : 1;
      let best = null, bestD = b.def.range;
      const bx = b.x + b.w/2, by = b.y + b.h/2;
      for(let u of GAME.entities.units){
        if(u.dead || u.team !== enemyTeam) continue;
        const d = Math.hypot((u.x) - bx, (u.y) - by);
        if(d < bestD){ bestD = d; best = u; }
      }
      for(let bb of GAME.entities.buildings){
        if(bb.dead || bb.team !== enemyTeam) continue;
        const cx = bb.x + bb.w/2, cy = bb.y + bb.h/2;
        const d = Math.hypot(cx - bx, cy - by);
        if(d < bestD){ bestD = d; best = bb; }
      }
      if(best && GAME.t > b.cd){
        const fr = b.def.fireRate || 1.1;
        b.cd = GAME.t + fr;
        if(b.def.proj) spawnProjFromBuilding(b, best, b.def.atk);
        else damage(best, b.def.atk);
      }
    }
  });

  const units = GAME.entities.units.filter(u => !u.dead);
  for(let i=0; i<units.length; i++){
      let u1 = units[i];
      if(u1.atkAnim > 0) u1.atkAnim -= dt;
      for(let j=i+1; j<units.length; j++){
          let u2 = units[j];
          if(Math.abs(u1.x-u2.x)>25 || Math.abs(u1.y-u2.y)>25) continue;
          let d = Math.hypot(u1.x-u2.x, u1.y-u2.y);
          if(d < 15){
             let push = (15-d)*2*dt;
             let ang = Math.atan2(u1.y-u2.y, u1.x-u2.x);
             u1.x += Math.cos(ang)*push; u1.y += Math.sin(ang)*push;
             u2.x -= Math.cos(ang)*push; u2.y -= Math.sin(ang)*push;
          }
      }
  }

  units.forEach(u => {
      if(!u.manualTarget) scanForThreats(u);
      if(u.target){
          if(u.target.dead || u.target.hp<=0){
              u.target = null; u.manualTarget = false; u.dest = null; u.state = 'IDLE';
          }
      }
      if(u.target) doCombat(u, dt);
      else if(u.task) doTask(u, dt);
      else if(u.dest) moveTo(u, u.dest.x, u.dest.y, dt);
  });

  for(let i=GAME.entities.proj.length-1; i>=0; i--){
      let p = GAME.entities.proj[i];
      if(!p.target || p.target.dead) { p.el.remove(); GAME.entities.proj.splice(i,1); continue; }
      const {tx, ty} = getTargetCenter(p.target);
      let d = Math.hypot(tx-p.x, ty-p.y);
      if(d < 10){
        damage(p.target, p.dmg);
        p.el.remove(); GAME.entities.proj.splice(i,1);
      }
      else {
        let spd = 400*dt;
        p.x += ((tx-p.x)/d)*spd;
        p.y += ((ty-p.y)/d)*spd;
        p.el.setAttribute('cx', p.x);
        p.el.setAttribute('cy', p.y);
      }
  }

  GAME.entities.particles.forEach((p,i) => {
      p.life-=dt; p.x+=p.vx*dt; p.y+=p.vy*dt;
      p.el.setAttribute('cx', p.x); p.el.setAttribute('cy', p.y); p.el.setAttribute('opacity', p.life);
      if(p.life<=0){ p.el.remove(); GAME.entities.particles[i]=null; }
  });
  GAME.entities.particles = GAME.entities.particles.filter(x=>x);
}

function scanForThreats(u){
    if(u.def.role === 'worker' && u.task) return;
    const AGGRO_RANGE = 200;
    let closestEnemy = null, minDist = AGGRO_RANGE;
    for(let e of GAME.entities.units){
        if(e.team !== u.team && !e.dead){
            let d = Math.hypot(u.x - e.x, u.y - e.y);
            if(d < minDist){ minDist = d; closestEnemy = e; }
        }
    }
    if(closestEnemy){ u.target = closestEnemy; u.dest = null; u.task = null; }
}

function doCombat(u, dt){
    let t = u.target;
    let dist = Math.hypot(u.x - (t.x+(t.w||0)/2), u.y - (t.y+(t.h||0)/2));
    let range = u.def.range + (t.w ? Math.max(t.w,t.h)/2 : 0);
    if(dist <= range){
        u.dest = null; u.face = t.x > u.x ? 1 : -1; u.atkAnim = 0.5;
        if(GAME.t > u.cd){
            u.cd = GAME.t + (u.def.type==='heavy'? 1.5 : (u.def.type==='siege'? 1.6 : 1.1));
            if(u.def.proj) spawnProj(u, t, u.def.atk); else damage(t, u.def.atk);
        }
    } else { moveTo(u, t.x+(t.w||0)/2, t.y+(t.h||0)/2, dt); }
}

function doTask(u, dt){
    let t = GAME.entities.props.find(p => p.id === u.task.id);
    if(u.task.type === 'build') t = GAME.entities.buildings.find(b => b.id === u.task.id);
    if(!t || (t.amt!==undefined && t.amt<=0) || (t.hp!==undefined && t.constructed)) { u.task=null; return; }

    let tx = t.x + (t.w?t.w/2:0), ty = t.y + (t.h?t.h/2:0);
    if(Math.hypot(u.x-tx, u.y-ty) > (t.w?t.w/2+10:20)){ moveTo(u, tx, ty, dt); }
    else {
        u.atkAnim = 0.5;
        if(GAME.t > u.cd){
            let factor = 1.0;
            u.cd = GAME.t + (1/factor);

            if(u.task.type==='gather'){
                let amt = 10; t.amt -= amt; spawnParticle(u.x, u.y-10, '#fbbf24', 0.5);
                if(u.team===myTeam){
                    if(t.type==='wood') GAME.player.wood+=amt; else if(t.type==='gold') GAME.player.gold+=amt; else GAME.player.hazel+=amt;
                    updateUI();
                }
                if(t.amt<=0) { t.el.remove(); t.dead=true; }
            } else {
                t.hp += (t.def.hp/t.def.buildTime);
                if(t.hp >= t.def.hp) { t.hp = t.def.hp; t.constructed = true; }
            }
        }
    }
}

function moveTo(u, x, y, dt){
    let ang = Math.atan2(y-u.y, x-u.x);
    u.x += Math.cos(ang) * u.def.spd * dt;
    u.y += Math.sin(ang) * u.def.spd * dt;
    u.face = Math.cos(ang) > 0 ? 1 : -1;
}

function damage(e, val){
    e.hp -= val; spawnParticle(e.x+(e.w?e.w/2:0), e.y+(e.h?e.h/2:0), '#ef4444', 0.5);
    if(e.hp <= 0){
      e.dead = true;
      if(e.el) e.el.remove();
      if(e.ui) e.ui.remove();
      if(e.type === 'TOWN') gameOver(e.team !== myTeam);
    }
}

function gameOver(win){
  const bgm = document.getElementById('bgm');
  if(bgm){ bgm.pause(); bgm.currentTime = 0; }
  GAME.over = true;
  const scr = document.getElementById('end-screen');
  const tit = document.getElementById('end-title');
  scr.style.display = 'flex';
  scr.classList.remove('game-over-show');
  void scr.offsetWidth;
  if(win){
    tit.innerText = "ZAFER SENİN!";
    tit.className = "game-over-title win";
  } else {
    tit.innerText = "YENİLGİ...";
    tit.className = "game-over-title lose";
  }
  setTimeout(() => scr.classList.add('game-over-show'), 50);
}

function render(dt){
  const vx=GAME.cam.x, vy=GAME.cam.y;
  GAME.dom.svg.setAttribute('viewBox', `${vx} ${vy} ${GAME.cam.w} ${GAME.cam.h}`);

  GAME.entities.units.forEach(u => {
    if(u.dead) return;
    const grp = u.el.querySelector('.w-grp');
    if(grp){
      if(u.atkAnim > 0) {
        let speed = u.type === 'F_KNIGHT' ? 10 : 20;
        grp.setAttribute('transform', `rotate(${-45 * Math.sin(GAME.t * speed)}, 5, 5)`);
      } else { grp.setAttribute('transform', 'none'); }
    }
    u.el.setAttribute('transform', `translate(${u.x},${u.y}) scale(${u.face},1)`);
    let showHp = GAME.selection.includes(u);
    u.el.querySelector('.hp-fill').style.display = showHp ? 'block' : 'none';
    if(showHp) u.el.querySelector('.hp-fill').setAttribute('width', Math.max(0,(u.hp/u.def.hp)*20));
  });

  GAME.entities.buildings.forEach(b => {
      if(b.dead) return;
      if(b.ui){
          let show = GAME.selection.includes(b) || (b.team === myTeam && !b.constructed);
          b.ui.style.display = show ? 'block' : 'none';
          if(show){
            b.ui.setAttribute('transform', `translate(${b.x},${b.y})`);
            b.ui.querySelector('.hp-fill').setAttribute('width', Math.max(0, (b.hp/b.def.hp)*b.w));
            b.ui.querySelector('.prod-fill').setAttribute('width', b.queue.length ? (b.queue[0].prog/b.queue[0].def.buildTime)*b.w : 0);
          }
      }
  });

  if(GAME.ghost.active && GAME.ghost.el){
      let gx = GAME.mouse.wx - GAME.ghost.w/2, gy = GAME.mouse.wy - GAME.ghost.h/2;
      GAME.ghost.el.setAttribute('transform', `translate(${gx},${gy})`);
      GAME.ghost.valid = checkPlacement(gx+GAME.ghost.w/2, gy+GAME.ghost.h/2, GAME.ghost.w, GAME.ghost.h);
      GAME.ghost.el.setAttribute('stroke', GAME.ghost.valid ? '#22c55e':'#ef4444');
  }

  if(GAME.mouse.down){
      let w = GAME.mouse.wx - GAME.mouse.dragStart.wx, h = GAME.mouse.wy - GAME.mouse.dragStart.wy;
      let sb = document.getElementById('selection-box');
      sb.style.left = (w<0?GAME.mouse.wx:GAME.mouse.dragStart.wx)-vx+'px';
      sb.style.top = (h<0?GAME.mouse.wy:GAME.mouse.dragStart.wy)-vy+'px';
      sb.style.width=Math.abs(w)+'px'; sb.style.height=Math.abs(h)+'px';
      sb.style.display='block';
  } else document.getElementById('selection-box').style.display='none';

  updateMiniMap();
}

function updateMiniMap(){
    const canvas = document.getElementById('minimap');
    if(canvas.width !== canvas.offsetWidth) { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
    const ctx = canvas.getContext('2d'); const cw = canvas.width, ch = canvas.height;
    ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,cw,ch); const sx = cw/CFG.w, sy = ch/CFG.h;
    GAME.entities.props.forEach(p => { ctx.fillStyle = p.type==='hazel'?'#65a30d' : p.type==='gold'?'#fbbf24':'#15803d'; ctx.fillRect(p.x*sx, p.y*sy, 3, 3); });
    GAME.entities.buildings.forEach(b => { if(b.dead) return; ctx.fillStyle = b.team===1?'#3b82f6':'#ef4444'; ctx.fillRect(b.x*sx, b.y*sy, 6, 6); });
    GAME.entities.units.forEach(u => { if(u.dead) return; ctx.fillStyle = u.team===1?'#93c5fd':'#fca5a5'; ctx.fillRect(u.x*sx, u.y*sy, 3, 3); });
    ctx.strokeStyle='#fff'; ctx.lineWidth=1; ctx.strokeRect(GAME.cam.x*sx, GAME.cam.y*sy, GAME.cam.w*sx, GAME.cam.h*sy);
}

function spawnUnit(type, team, x, y, forcedId=null){
  const def = DB.UNIT[type];
  const el = document.createElementNS(NS, 'g'); el.innerHTML = getUnitSVG(type, team);
  el.innerHTML += `<rect class="hp-fill" x="-10" y="-25" width="20" height="3" fill="${team===1?'#0f0':'#f00'}" style="display:none"/>`;
  GAME.dom.layers.units.appendChild(el);
  const u = {id: forcedId || rng(), type, def, team, x, y, hp:def.hp, cd:0, task:null, target:null, dest:null, el, face:1, atkAnim:0, manualTarget:false, state:'IDLE'};
  GAME.entities.units.push(u);
  if(team===myTeam) updateUI();
  return u;
}

function spawnBuilding(type, team, x, y, built=false, forcedId=null){
  const def = DB.BUILD[type];
  const el = document.createElementNS(NS, 'g'); el.innerHTML = getBuildingSVG(type, team);
  el.setAttribute('transform', `translate(${x},${y})`);
  GAME.dom.layers.build.appendChild(el);

  const hpColor = team === 1 ? COLORS.p1 : COLORS.p2;
  const ui = document.createElementNS(NS, 'g');
  ui.innerHTML = `<rect x="0" y="-15" width="${def.w}" height="6" fill="#000" fill-opacity="0.6"/><rect class="hp-fill" x="0" y="-15" width="${built?def.w:0}" height="6" fill="${hpColor}"/><rect class="prod-fill" x="0" y="-8" width="0" height="4" fill="#fbbf24"/>`;
  ui.style.display='none';
  GAME.dom.layers.ui.appendChild(ui);

  const b = {id: forcedId || rng(), type, def, team, x, y, w:def.w, h:def.h, hp:built?def.hp:1, constructed:built, queue:[], el, ui, dead:false, cd:0};
  GAME.entities.buildings.push(b);
  if(team===myTeam) updateUI();
  return b;
}

function spawnParticle(x, y, c, op){
    const el = document.createElementNS(NS, 'circle'); el.setAttribute('r', 2+rng()*3); el.setAttribute('fill', c);
    GAME.dom.layers.fx.appendChild(el);
    GAME.entities.particles.push({x, y, vx:(rng()-0.5)*20, vy:-30-rng()*20, life:op, el});
}

function spawnProj(u, t, dmg){
    const el = document.createElementNS(NS, 'circle'); el.setAttribute('r', 3); el.setAttribute('fill', '#000');
    GAME.dom.layers.fx.appendChild(el);
    GAME.entities.proj.push({x:u.x, y:u.y, target:t, dmg, el});
}

function spawnProjFromBuilding(b, t, dmg){
    const el = document.createElementNS(NS, 'circle'); el.setAttribute('r', 3); el.setAttribute('fill', '#000');
    GAME.dom.layers.fx.appendChild(el);
    GAME.entities.proj.push({x:b.x + b.w/2, y:b.y + 18, target:t, dmg, el});
}

function updatePanel(forceFull = false){
    const pi = document.getElementById('panel-info');
    const pa = document.getElementById('panel-actions');
    if(!GAME.selection.length) { pi.innerHTML=''; pa.innerHTML=''; GAME.lastSelectionId=null; return; }
    const h = GAME.selection[0];
    if(GAME.lastSelectionId === h.id && !forceFull){
      const hpSpan = document.getElementById('ui-hp-val');
      if(hpSpan) hpSpan.innerText = Math.floor(h.hp);
      return;
    }
    GAME.lastSelectionId = h.id;
    let color = h.team===1 ? '#22c55e' : '#ef4444';
    pi.innerHTML = `<div style="color:${color};font-weight:bold;font-size:16px;">${h.def.name}</div><div style="font-size:12px; color:#94a3b8;">${h.def.desc || ''}</div><div style="margin-top:5px;">HP: <span id="ui-hp-val" style="color:#fff; font-weight:bold;">${Math.floor(h.hp)}</span> / ${h.def.hp}</div>`;
    pa.innerHTML = '';
    if(h.team !== myTeam) return;

    if(h.def.role === 'worker'){
        addBtn(pa, DB.BUILD.HOUSE, ()=>prepBuild('HOUSE'));
        addBtn(pa, DB.BUILD.BARRACKS, ()=>prepBuild('BARRACKS'));
        addBtn(pa, DB.BUILD.ARCHERY, ()=>prepBuild('ARCHERY'));
        addBtn(pa, DB.BUILD.STABLE, ()=>prepBuild('STABLE'));
        addBtn(pa, DB.BUILD.ARROW_TOWER, ()=>prepBuild('ARROW_TOWER'));
    } else if(h.queue){
        if(h.type === 'HOUSE') addBtn(pa, DB.UNIT.VILLAGER, ()=>queueUnit(h, 'VILLAGER'));
        if(h.type === 'BARRACKS') addBtn(pa, DB.UNIT.PIKEMAN, ()=>queueUnit(h, 'PIKEMAN'));
        if(h.type === 'ARCHERY') {
          addBtn(pa, DB.UNIT.ARCHER, ()=>queueUnit(h, 'ARCHER'));
          addBtn(pa, DB.UNIT.CATAPULT, ()=>queueUnit(h, 'CATAPULT'));
        }
        if(h.type === 'STABLE') {
          addBtn(pa, DB.UNIT.KNIGHT, ()=>queueUnit(h, 'KNIGHT'));
          addBtn(pa, DB.UNIT.F_KNIGHT, ()=>queueUnit(h, 'F_KNIGHT'));
        }
    }
}

function updateLiveUI(){ if(GAME.selection.length > 0) updatePanel(false); }

function addBtn(p, def, cb){
    const d = document.createElement('div'); d.className='card';

    let titleHtml = `<div class="card-title" title="${def.name}">${def.name}</div>`;
    let iconSvg = ICONS.WOOD;
    if(def.visual && ICONS[def.visual]) iconSvg = ICONS[def.visual];
    else if(def.icon && def.icon.length > 3) iconSvg = def.icon;

    let costHtml = '<div class="card-cost">';
    if(def.cost.gold) costHtml += `<div class="cost-row" style="color:#fbbf24"><svg class="mini-icon" viewBox="0 0 24 24">${ICONS.GOLD.match(/<svg.*?>(.*?)<\/svg>/)[1]}</svg> ${def.cost.gold}</div>`;
    if(def.cost.wood) costHtml += `<div class="cost-row wood"><svg class="mini-icon" viewBox="0 0 24 24">${ICONS.WOOD.match(/<svg.*?>(.*?)<\/svg>/)[1]}</svg> ${def.cost.wood}</div>`;
    if(def.cost.hazel) costHtml += `<div class="cost-row hazel"><svg class="mini-icon" viewBox="0 0 24 24">${ICONS.HAZEL.match(/<svg.*?>(.*?)<\/svg>/)[1]}</svg> ${def.cost.hazel}</div>`;
    costHtml += '</div>';

    d.innerHTML = `${titleHtml}${iconSvg}${costHtml}`;
    d.onclick = cb; p.appendChild(d);
}

function prepBuild(type){
    if(type==='TOWN') return;
    GAME.ghost = {active:true, type, w:DB.BUILD[type].w, h:DB.BUILD[type].h, el:document.createElementNS(NS,'rect'), valid:false};
    GAME.ghost.el.setAttribute('width', GAME.ghost.w);
    GAME.ghost.el.setAttribute('height', GAME.ghost.h);
    GAME.ghost.el.setAttribute('fill', 'rgba(255,255,255,0.3)');
    GAME.dom.layers.ui.appendChild(GAME.ghost.el);
}

// YENİ EKLENEN: İnşaatı güvenli bir şekilde iptal etme
function cancelBuild(){
    if(GAME.ghost.el) GAME.ghost.el.remove();
    GAME.ghost = { active: false, type: null, el: null, valid: false };
}

function tryBuild(){
    if(!GAME.ghost.valid) {
        showToast("Geçersiz Konum");
        cancelBuild(); // Ghost'u temizle
        return;
    }
    const c = DB.BUILD[GAME.ghost.type].cost;
    if(GAME.player.wood >= (c.wood||0) && GAME.player.gold >= (c.gold||0)){
        GAME.player.wood-=(c.wood||0);
        GAME.player.gold-=(c.gold||0);
        updateUI();

        const bx = GAME.mouse.wx-GAME.ghost.w/2;
        const by = GAME.mouse.wy-GAME.ghost.h/2;

        const bid = 'b_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
        let b = spawnBuilding(GAME.ghost.type, myTeam, bx, by, false, bid);

        const workers = GAME.selection.filter(u => u.team===myTeam && u.def.role==='worker' && !u.dead);
        workers.forEach(u => { u.task={type:'build', id:b.id}; });

        sendAction({
          type:'BUILD',
          bType: GAME.ghost.type,
          x: bx,
          y: by,
          bid,
          uids: workers.map(u=>u.id)
        });

        cancelBuild(); // Başarılı olsa da ghost'u temizle
    } else {
        showToast("Yetersiz Kaynak");
        cancelBuild(); // Kaynak yoksa da temizle
    }
}

function queueUnit(b, type){
    const c = DB.UNIT[type].cost;
    let houseCap = GAME.entities.buildings
      .filter(x=>x.team===myTeam && x.constructed && (x.type==='HOUSE'||x.type==='TOWN'))
      .reduce((a,x)=>a+x.def.cap,0);

    let curPop = GAME.entities.units.filter(u=>u.team===myTeam && !u.dead).length + b.queue.length;
    if(curPop >= houseCap) { showToast("Nüfus Limiti Dolu! Ev Yap."); return; }

    if(GAME.player.wood >= (c.wood||0) && GAME.player.gold >= (c.gold||0) && GAME.player.hazel >= (c.hazel||0)){
        GAME.player.wood-=(c.wood||0); GAME.player.gold-=(c.gold||0); GAME.player.hazel-=(c.hazel||0); updateUI();

        const newUid = 'u_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
        b.queue.push({type, def:DB.UNIT[type], prog:0, forcedId: newUid});
        updatePanel(true);

        sendAction({ type:'TRAIN', bid: b.id, uType: type, newUid });
    } else showToast("Yetersiz Kaynak");
}

function updateUI(){
    document.getElementById('ui-gold').innerText = Math.floor(GAME.player.gold);
    document.getElementById('ui-wood').innerText = Math.floor(GAME.player.wood);
    document.getElementById('ui-hazel').innerText = Math.floor(GAME.player.hazel);

    let houseCap = GAME.entities.buildings
      .filter(x=>x.team===myTeam && x.constructed && (x.type==='HOUSE'||x.type==='TOWN'))
      .reduce((a,x)=>a+x.def.cap,0);

    let curPop = GAME.entities.units.filter(u=>u.team===myTeam && !u.dead).length;

    document.getElementById('ui-pop').innerText = `${curPop}/${houseCap}`;
}

function showToast(m){
  const t=document.getElementById('toast-msg');
  t.innerText=m;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2000);
}

function setupInputs(){
    window.onkeydown = e => GAME.keys[e.key]=true;
    window.onkeyup = e => GAME.keys[e.key]=false;
    window.onmousemove = e => {
      GAME.mouse.screenX = e.clientX; GAME.mouse.screenY = e.clientY;
      GAME.mouse.wx = GAME.cam.x + e.clientX; GAME.mouse.wy = GAME.cam.y + e.clientY;
    };
    const stg = document.getElementById('game-stage');
    stg.onmousedown = e => {
      if(e.button===0){
        if(GAME.ghost.active) tryBuild();
        else { GAME.mouse.down=true; GAME.mouse.dragStart={wx:GAME.mouse.wx, wy:GAME.mouse.wy}; }
      } else if(e.button===2){
        // GÜNCELLEME: Sağ tıkta inşaatı iptal et
        if(GAME.ghost.active) { cancelBuild(); return; }
        e.preventDefault(); handleRightClick();
      }
    };
    stg.onmouseup = e => {
      if(e.button===0 && GAME.mouse.down){
        GAME.mouse.down=false;
        if(Math.hypot(GAME.mouse.wx-GAME.mouse.dragStart.wx, GAME.mouse.wy-GAME.mouse.dragStart.wy)<5) selectPoint();
        else selectBox();
      }
    };
    stg.oncontextmenu = e => e.preventDefault();

    const mm = document.querySelector('.minimap-wrapper');
    const onMinimap = (e) => {
        const rect = mm.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        GAME.cam.x = (x / rect.width * CFG.w) - GAME.cam.w/2;
        GAME.cam.y = (y / rect.height * CFG.h) - GAME.cam.h/2;
        GAME.cam.x = Math.max(0, Math.min(GAME.cam.x, CFG.w - GAME.cam.w));
        GAME.cam.y = Math.max(0, Math.min(GAME.cam.y, CFG.h - GAME.cam.h));
    };
    mm.onmousedown = (e) => {
        onMinimap(e);
        const move = (ev) => onMinimap(ev);
        const up = () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', up);
    };
}

function selectPoint(){
    const mx = GAME.mouse.wx, my = GAME.mouse.wy; GAME.selection = [];
    let u = GAME.entities.units.find(u => !u.dead && Math.hypot(u.x-mx, u.y-my) < 30);
    if(u) GAME.selection.push(u);
    else {
      let b = GAME.entities.buildings.find(b => !b.dead && mx>b.x && mx<b.x+b.w && my>b.y && my<b.y+b.h);
      if(b) GAME.selection.push(b);
    }
    updatePanel(true);
}

function selectBox(){
    const x1 = Math.min(GAME.mouse.dragStart.wx, GAME.mouse.wx), x2 = Math.max(GAME.mouse.dragStart.wx, GAME.mouse.wx);
    const y1 = Math.min(GAME.mouse.dragStart.wy, GAME.mouse.wy), y2 = Math.max(GAME.mouse.dragStart.wy, GAME.mouse.wy);
    GAME.selection = GAME.entities.units.filter(u => !u.dead && u.team===myTeam && u.x>x1 && u.x<x2 && u.y>y1 && u.y<y2);
    updatePanel(true);
}

function handleRightClick(){
    const mx = GAME.mouse.wx, my = GAME.mouse.wy;
    const enemyTeam = (myTeam === 1 ? 2 : 1);

    let t =
      GAME.entities.units.find(u => !u.dead && u.team===enemyTeam && Math.hypot(u.x-mx, u.y-my)<30) ||
      GAME.entities.buildings.find(b => !b.dead && b.team===enemyTeam && mx>b.x && mx<b.x+b.w && my>b.y && my<b.y+b.h) ||
      GAME.entities.props.find(p => !p.dead && Math.hypot(p.x-mx, p.y-my)<30) ||
      GAME.entities.buildings.find(b => !b.dead && b.team===myTeam && !b.constructed && mx>b.x && mx<b.x+b.w && my>b.y && my<b.y+b.h);

    const mySelected = GAME.selection.filter(u => u.team === myTeam && !u.dead);
    if(!mySelected.length) return;

    // Local uygula
    mySelected.forEach(u => {
        if(u.def.role === 'worker'){
            if(t && t.amt) { u.task={type:'gather', id:t.id}; u.manualTarget=false; u.target=null; u.dest=null; }
            else if(t && t.team===myTeam && !t.constructed) { u.task={type:'build', id:t.id}; u.manualTarget=false; u.target=null; u.dest=null; }
            else if(t && t.team===enemyTeam) { u.task=null; u.target=t; u.manualTarget=true; u.dest=null; }
            else { u.task=null; u.target=null; u.manualTarget=false; u.dest={x:mx, y:my}; }
        } else {
            if(t && t.team===enemyTeam) { u.target=t; u.manualTarget=true; u.dest=null; }
            else { u.target=null; u.manualTarget=false; u.dest={x:mx, y:my}; }
        }
    });

    // Online gönder
    const uids = mySelected.map(u => u.id);
    if(t && t.team && t.team !== myTeam){
      sendAction({ type:'ATTACK', uids, tid: t.id });
    } else if(t && t.amt){
      sendAction({ type:'GATHER', uids, tid: t.id });
    } else if(t && t.team === myTeam && !t.constructed){
      sendAction({ type:'BUILD', uids, bid: t.id, bType: t.type, x: t.x, y: t.y });
    } else {
      sendAction({ type:'MOVE', uids, x: mx, y: my });
    }
}
</script>
</body>
</html>
